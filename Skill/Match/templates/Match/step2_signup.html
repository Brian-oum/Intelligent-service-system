<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Service Provider Sign-Up Step 2</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
</head>
<body class="bg-light">

<div class="container mt-5">
  <div class="card shadow-sm">
    <div class="card-body">
      <h2 class="card-title mb-3">Step 2: Company Profile</h2>
      <p class="text-muted">Hi {{ user.username }}, please complete your company profile.</p>

      <form method="POST" enctype="multipart/form-data">
        {% csrf_token %}

        <h5 class="mt-3">Company Profile</h5>
        {% for field in provider_form %}
          <div class="mb-3">
            {{ field.label_tag }} 
            {{ field }}
            {% if field.errors %}
              <div class="text-danger small">{{ field.errors }}</div>
            {% endif %}
          </div>
        {% endfor %}

        <h5 class="mt-4">Upload Company Documents (up to 3)</h5>
        {% for form in doc_forms %}
          {% for field in form %}
            <div class="mb-3">
              {{ field.label_tag }}
              {{ field }}
              {% if field.errors %}
                <div class="text-danger small">{{ field.errors }}</div>
              {% endif %}
            </div>
          {% endfor %}
        {% endfor %}

        <h5 class="mt-4">Select Your Company Location</h5>
        <div id="map" class="mb-3 border rounded" style="height: 350px;"></div>
        <p class="text-muted small">
          Click anywhere on the map to select your exact company location.
        </p>

        <button type="submit" class="btn btn-success w-100">Finish Sign-Up</button>
      </form>
    </div>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const defaultLat = -1.286389;  // Nairobi fallback
    const defaultLon = 36.817223;
    const latInput = document.getElementById('id_latitude');
    const lonInput = document.getElementById('id_longitude');
    let map, marker;

    function initMap(lat, lon) {
        map = L.map('map').setView([lat, lon], 13);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; OpenStreetMap contributors'
        }).addTo(map);

        marker = L.marker([lat, lon], {draggable: true}).addTo(map)
            .bindPopup("Drag or click to update your location.")
            .openPopup();

        // Update hidden fields when marker dragged
        marker.on('dragend', function(e) {
            const pos = e.target.getLatLng();
            latInput.value = pos.lat.toFixed(6);
            lonInput.value = pos.lng.toFixed(6);
        });

        // Update marker when map clicked
        map.on('click', function(e) {
            const { lat, lng } = e.latlng;
            marker.setLatLng(e.latlng);
            latInput.value = lat.toFixed(6);
            lonInput.value = lng.toFixed(6);
        });
    }

    // Try to get current location
    if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(
            function(position) {
                const lat = position.coords.latitude;
                const lon = position.coords.longitude;
                latInput.value = lat;
                lonInput.value = lon;
                initMap(lat, lon);
            },
            function(error) {
                console.warn("Geolocation failed:", error.message);
                latInput.value = defaultLat;
                lonInput.value = defaultLon;
                initMap(defaultLat, defaultLon);
            }
        );
    } else {
        console.warn("Geolocation not supported");
        latInput.value = defaultLat;
        lonInput.value = defaultLon;
        initMap(defaultLat, defaultLon);
    }
});
</script>

</body>
</html>
