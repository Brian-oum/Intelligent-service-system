{% extends "Match/base.html" %}
{% load static %}
{% block content %}

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<style>
    :root {
        --form-border-color: #d1d5db;
        --accent-success: #28a745;
        --text-main: #374151;
    }

    body { font-family: 'Segoe UI', Roboto, sans-serif; background-color: #f8f9fa; }

    h2.billing-header { 
        font-size:1.8rem; font-weight:600; color: var(--text-main); 
        border-bottom:3px solid #000; padding-bottom:5px; margin-bottom:25px; 
        display:inline-block; 
    }

    .doc-form { 
        background-color:#fff; padding:25px; border-radius:20px; 
        border:1px solid #e5e7eb; margin-bottom:20px;
    }

    label { font-weight:600; margin-bottom:8px; display:block; color: var(--text-main); }

    input, textarea, select { 
        width:100%; padding:12px 20px; border:1px solid var(--form-border-color);
        border-radius:50px !important; font-size:14px; transition: all 0.2s;
    }

    input:focus { border-color: #000; outline:none; box-shadow:0 0 0 2px rgba(0,0,0,0.05); }

    .map-trigger-input { cursor:pointer; background-color:#f3f4f6 !important; border: 1px dashed #9ca3af; }

    /* Map Styling */
    #map { 
        width:100%; height:450px; border-radius:15px; 
        border:1px solid #ddd; z-index: 1;
    }
    
    .btn-pill { border-radius:50px; padding:12px 35px; font-weight:600; }
    .btn-complete { background-color:#000; color:#fff; border:none; width:100%; transition: 0.3s; }
    .btn-complete:hover { background-color:#333; transform:translateY(-2px); }

    .modal-content { border-radius:25px; border:none; overflow: hidden; }
</style>

<div class="container my-5">
    <div class="row justify-content-center">
        <div class="col-lg-10">
            <h2 class="billing-header">Professional Details</h2>

            {% if provider_form.errors or service_form.errors or document_form.errors %}
                <div class="alert alert-danger shadow-sm mb-4" style="border-radius: 15px;">
                    <h6 class="fw-bold">Please correct the following:</h6>
                    <ul class="mb-0 small">
                        {% for field in provider_form %}{% for error in field.errors %}<li><strong>Provider:</strong> {{ error }}</li>{% endfor %}{% endfor %}
                        {% for field in service_form %}{% for error in field.errors %}<li><strong>Service:</strong> {{ error }}</li>{% endfor %}{% endfor %}
                        {% for field in document_form %}{% for error in field.errors %}<li><strong>Doc:</strong> {{ error }}</li>{% endfor %}{% endfor %}
                    </ul>
                </div>
            {% endif %}

            <form method="POST" enctype="multipart/form-data" novalidate>
                {% csrf_token %}

                <section class="doc-form shadow-sm">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label>Company Name *</label>
                            {{ provider_form.company_name }}
                        </div>
                        <div class="col-md-6 mb-3">
                            <label>Contact Number *</label>
                            {{ provider_form.contact_number }}
                        </div>
                        <div class="col-md-6 mb-3">
                            <label>Physical Address *</label>
                            {{ provider_form.address }}
                        </div>
                        <div class="col-md-6 mb-3">
                            <label>Company Location *</label>
                            <input type="text" id="display_location" class="map-trigger-input" 
                                   placeholder="üìç Click to pin location on map" readonly
                                   data-bs-toggle="modal" data-bs-target="#mapModal">
                        </div>
                        {{ provider_form.latitude }}
                        {{ provider_form.longitude }}
                    </div>
                </section>

                <section class="doc-form shadow-sm">
                    <h5>Service Details</h5>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label>Category</label>
                            {{ service_form.category }}
                                <datalist id="category_list">
                                    {% for cat in categories %}
                                        <option value="{{ cat.name }}">
                                    {% endfor %}
                                </datalist>
                        </div>

                        <div class="col-md-6 mb-3">
                            <label>Service Title</label>
                            {{ service_form.title }}
                        </div>
                        <div class="col-12 mb-3">
                            <label>Description</label>
                            {{ service_form.description }}
                        </div>
                        <div class="col-md-6 mb-3">
                            <label>Min Price</label>
                            {{ service_form.min_price }}
                        </div>
                        <div class="col-md-6 mb-3">
                            <label>Max Price</label>
                            {{ service_form.max_price }}
                        </div>
                    </div>
                </section>

                <section class="doc-form shadow-sm">
                    <h5>Verification</h5>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label>Document Name</label>
                            {{ document_form.document_name }}
                        </div>
                        <div class="col-md-6 mb-3">
                            <label>File Upload</label>
                            {{ document_form.document_file }}
                        </div>
                    </div>
                </section>

                <div class="mt-4 text-center">
                    <button type="submit" class="btn-pill btn-complete btn-lg w-50 shadow">Complete Profile</button>
                </div>
            </form>
        </div>
    </div>
</div>

<div class="modal fade" id="mapModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-xl modal-dialog-centered">
        <div class="modal-content shadow-lg">
            <div class="modal-header border-0 pb-0">
                <h5 class="fw-bold">Select Business Location</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="input-group mb-3">
                    <input type="text" id="map-search" class="form-control" placeholder="Search for a place (e.g. Nairobi, Westlands)">
                    <button class="btn btn-dark px-4" type="button" id="search-btn">Search</button>
                </div>
                <div id="map"></div>
            </div>
            <div class="modal-footer border-0">
                <button type="button" id="confirmLocation" class="btn btn-success btn-pill px-5">Confirm Pinned Location</button>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    let map, marker;
    
    // Selectors using partial ID match to handle prefixes like id_provider-latitude
    const latInput = document.querySelector("input[id$='latitude']");
    const lngInput = document.querySelector("input[id$='longitude']");
    const displayInput = document.getElementById("display_location");
    const mapSearch = document.getElementById("map-search");
    const mapModalElement = document.getElementById('mapModal');

    // Initialize Map on Modal Open
    mapModalElement.addEventListener('shown.bs.modal', function () {
        // Small delay to ensure Modal animation is finished
        setTimeout(() => {
            if (!map) {
                map = L.map("map").setView([-1.286389, 36.817223], 13);
                
                L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
                    attribution: '¬© OpenStreetMap'
                }).addTo(map);

                map.on("click", function (e) {
                    updateMarker(e.latlng.lat, e.latlng.lng);
                });
            }
            map.invalidateSize(); // Fixes the gray tiles issue
        }, 200);
    });

    function updateMarker(lat, lng) {
        if (marker) map.removeLayer(marker);
        marker = L.marker([lat, lng]).addTo(map);
        latInput.value = lat;
        lngInput.value = lng;
    }

    // Search Box Functionality
    document.getElementById("search-btn").addEventListener("click", function() {
        const query = mapSearch.value;
        if (query) {
            fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${query}`)
                .then(r => r.json())
                .then(data => {
                    if (data.length > 0) {
                        const result = data[0];
                        const lat = parseFloat(result.lat);
                        const lon = parseFloat(result.lon);
                        map.setView([lat, lon], 16);
                        updateMarker(lat, lon);
                    } else {
                        alert("Location not found.");
                    }
                });
        }
    });

    // Close Modal and Show feedback
    document.getElementById("confirmLocation").addEventListener("click", function() {
        if (latInput.value && lngInput.value) {
            displayInput.value = "üìç Location Pinned (" + parseFloat(latInput.value).toFixed(3) + ", " + parseFloat(lngInput.value).toFixed(3) + ")";
            displayInput.style.border = "1px solid #28a745";
            bootstrap.Modal.getInstance(mapModalElement).hide();
        } else {
            alert("Please click on the map to place a marker first.");
        }
    });
});
</script>

{% endblock %}