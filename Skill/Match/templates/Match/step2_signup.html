{% extends 'Match/base.html' %}

{% block title %}Complete Your Provider Profile{% endblock %}

{% block content %}
<div class="container mt-5 mb-5">
    <div class="card shadow-sm">
        <div class="card-body">
            <h2 class="card-title mb-3">Complete Your Provider Profile</h2>
            <p class="text-muted">Hi {{ user.username }}, complete your profile, upload documents, and add services you offer.</p>

            <form method="POST" enctype="multipart/form-data">
                {% csrf_token %}

                <!-- ========================= -->
                <!-- Company Profile -->
                <!-- ========================= -->
                <h5>Company Profile</h5>
                {% for field in provider_form %}
                    {% if field.name not in "latitude longitude address" %}
                        <div class="mb-3">
                            {{ field.label_tag }}
                            {{ field }}
                            {% if field.errors %}
                                <div class="text-danger">{{ field.errors }}</div>
                            {% endif %}
                        </div>
                    {% endif %}
                {% endfor %}

                <!-- Location -->
                <h5 class="mt-4">Company Location</h5>
                <div class="mb-3">
                    <label for="location_search" class="form-label">Search Area</label>
                    <input type="text" id="location_search" class="form-control" placeholder="Enter area or city name...">
                </div>

                <div id="map" class="mb-3" style="height: 300px; border-radius: 8px; border: 1px solid #ccc;"></div>

                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label for="id_latitude" class="form-label">Latitude</label>
                        {{ provider_form.latitude }}
                    </div>
                    <div class="col-md-6 mb-3">
                        <label for="id_longitude" class="form-label">Longitude</label>
                        {{ provider_form.longitude }}
                    </div>
                </div>

                <div class="mb-3">
                    <label for="id_address" class="form-label">Address</label>
                    {{ provider_form.address }}
                </div>

                <!-- ========================= -->
                <!-- Company Documents -->
                <!-- ========================= -->
                <h5 class="mt-4">Company Documents (up to 3)</h5>
                {% for form in doc_forms %}
                    {% for field in form %}
                        <div class="mb-3">
                            {{ field.label_tag }}
                            {{ field }}
                            {% if field.errors %}
                                <div class="text-danger">{{ field.errors }}</div>
                            {% endif %}
                        </div>
                    {% endfor %}
                {% endfor %}

                <!-- ========================= -->
                <!-- Services Offered -->
                <!-- ========================= -->
                <h5 class="mt-4">Services You Offer</h5>
                {% for form in service_forms %}
                    <div class="border p-3 mb-3 rounded">
                        {% for field in form %}
                            <div class="mb-2">
                                {{ field.label_tag }}
                                {{ field }}
                                {% if field.errors %}
                                    <div class="text-danger">{{ field.errors }}</div>
                                {% endif %}
                            </div>
                        {% endfor %}
                    </div>
                {% endfor %}

                <button type="submit" class="btn btn-success w-100">Complete Profile</button>
            </form>
        </div>
    </div>
</div>

<!-- Leaflet Map -->
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const defaultLat = -1.286389;
    const defaultLon = 36.817223;

    const map = L.map('map').setView([defaultLat, defaultLon], 13);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; OpenStreetMap contributors'
    }).addTo(map);

    const marker = L.marker([defaultLat, defaultLon], { draggable: true }).addTo(map);

    const latInput = document.getElementById('id_latitude');
    const lonInput = document.getElementById('id_longitude');
    const addressInput = document.getElementById('id_address');
    const searchInput = document.getElementById('location_search');

    async function reverseGeocode(lat, lon) {
        try {
            const res = await fetch(`https://nominatim.openstreetmap.org/reverse?lat=${lat}&lon=${lon}&format=json`);
            const data = await res.json();
            if (data.display_name) addressInput.value = data.display_name;
        } catch(err){ console.error(err); }
    }

    async function geocode(query) {
        try {
            const res = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}`);
            const data = await res.json();
            if (data.length > 0) {
                const { lat, lon, display_name } = data[0];
                map.setView([lat, lon], 15);
                marker.setLatLng([lat, lon]);
                latInput.value = lat;
                lonInput.value = lon;
                addressInput.value = display_name;
            } else {
                alert("Location not found.");
            }
        } catch(err){ console.error(err); }
    }

    searchInput.addEventListener('keypress', function(e) {
        if (e.key === 'Enter') { e.preventDefault(); const query = searchInput.value.trim(); if (query) geocode(query); }
    });

    marker.on('moveend', async function(e) {
        const { lat, lng } = e.target.getLatLng();
        latInput.value = lat;
        lonInput.value = lng;
        await reverseGeocode(lat, lng);
    });

    if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(async function(pos) {
            const { latitude, longitude } = pos.coords;
            map.setView([latitude, longitude], 15);
            marker.setLatLng([latitude, longitude]);
            latInput.value = latitude;
            lonInput.value = longitude;
            await reverseGeocode(latitude, longitude);
        }, () => reverseGeocode(defaultLat, defaultLon));
    }
});
</script>
{% endblock %}
